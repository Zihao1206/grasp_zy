# ROS2 抓取系统架构说明

## 系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                       ROS2 抓取系统                              │
└─────────────────────────────────────────────────────────────────┘

┌──────────────────┐         ┌──────────────────┐         ┌──────────────────┐
│   硬件层          │         │   ROS2 中间件     │         │   应用层          │
├──────────────────┤         ├──────────────────┤         ├──────────────────┤
│                  │         │                  │         │                  │
│ ┌──────────┐     │         │  话题 (Topics)    │         │ ┌──────────┐     │
│ │RealSense │────────────> │  /camera/color   ├────────> │ │ 抓取执行器 │     │
│ │  D435    │     │         │  /camera/depth   │         │ │  (Action)  │     │
│ └──────────┘     │         │                  │         │ └──────────┘     │
│                  │         │  服务 (Services) │         │       │          │
│ ┌──────────┐     │         │  /detect_objects │         │       │          │
│ │  RM65    │<───────────── │  /generate_grasp├────────┐ │       │          │
│ │机械臂     │     │         │  /gripper_control│        │ │       │          │
│ └──────────┘     │         │                  │        │ │       ▼          │
│                  │         │  动作 (Actions)  │        │ │  ┌──────────┐   │
│ ┌──────────┐     │         │  /execute_grasp  │        ├──> │ 视觉处理  │   │
│ │夹爪       │<───────────── │                  │        │ │  │           │   │
│ │          │     │         │                  │        │ │  └──────────┘   │
│ └──────────┘     │         │                  │        │ │                  │
│                  │         │                  │        │ │  ┌──────────┐   │
└──────────────────┘         └──────────────────┘        └──> │ 控制模块  │   │
                                                              │           │   │
                                                              └──────────┘   │
                                                                             │
                                                              └──────────────┘
```

## 数据流详解

### 1. 图像采集流程

```
RealSense相机
    │
    ├─> 获取RGB图像 ────> /camera/color/image_raw (话题)
    │
    └─> 获取深度图像 ───> /camera/depth/image_raw (话题)
```

### 2. 检测流程

```
客户端请求
    │
    ├─> 调用 /detect_objects (服务)
    │       │
    │       ├─> 接收RGB图像
    │       │
    │       ├─> MMDetection推理
    │       │
    │       ├─> NMS过滤
    │       │
    │       └─> 返回检测结果
    │
    └─> 返回: 边界框、掩码、类别、置信度
```

### 3. 抓取姿态生成流程

```
客户端请求
    │
    ├─> 调用 /generate_grasp (服务)
    │       │
    │       ├─> 接收RGB+深度图像
    │       ├─> 接收检测结果
    │       │
    │       ├─> 生成目标掩码
    │       │
    │       ├─> CNN推理抓取点
    │       │
    │       ├─> 坐标系转换
    │       │   (图像坐标 → 相机坐标 → 基座坐标)
    │       │
    │       ├─> 边缘倾斜补偿
    │       │
    │       └─> 返回抓取姿态列表
    │
    └─> 返回: 位置、姿态、夹爪宽度、质量分数
```

### 4. 完整抓取流程

```
grasp_executor (动作服务器)
    │
    ├─> 1. 等待图像
    │       └─> 订阅相机话题
    │
    ├─> 2. 目标检测
    │       └─> 调用 /detect_objects 服务
    │
    ├─> 3. 生成抓取姿态
    │       └─> 调用 /generate_grasp 服务
    │
    ├─> 4. 计算逆运动学
    │       └─> 使用机械臂SDK
    │
    ├─> 5. 执行运动序列
    │       ├─> 移动到中间位置
    │       ├─> 移动到上方安全位置
    │       ├─> 打开夹爪 (调用 /gripper_control)
    │       ├─> 下降到抓取位置
    │       ├─> 闭合夹爪
    │       ├─> 提升
    │       ├─> 移动到放置位置
    │       ├─> 打开夹爪
    │       └─> 返回初始位置
    │
    └─> 6. 返回结果
            └─> 成功/失败 + 消息
```

## 节点详细说明

### camera_node (grasp_vision)

**功能**: 发布相机图像

**发布话题**:
- `/camera/color/image_raw` (sensor_msgs/Image) - RGB图像
- `/camera/depth/image_raw` (sensor_msgs/Image) - 深度图像

**参数**:
- `width`: 图像宽度 (默认: 640)
- `height`: 图像高度 (默认: 480)
- `publish_rate`: 发布频率 (默认: 10 Hz)

**依赖**:
- RealSense SDK
- pyrealsense2

---

### detection_server (grasp_vision)

**功能**: 提供目标检测服务

**服务**:
- `/detect_objects` (grasp_interfaces/srv/DetectObjects)
  - 输入: RGB图像
  - 输出: 检测结果(边界框、掩码、类别、置信度)

**参数**:
- `config_file`: MMDetection配置文件
- `checkpoint`: 模型权重文件
- `device`: 计算设备 (cuda/cpu)
- `nms_score_threshold`: NMS分数阈值
- `nms_iou_threshold`: NMS IoU阈值

**依赖**:
- PyTorch
- MMDetection
- CUDA (可选)

---

### grasp_generator (grasp_vision)

**功能**: 生成抓取姿态

**服务**:
- `/generate_grasp` (grasp_interfaces/srv/GenerateGrasp)
  - 输入: RGB图像、深度图像、检测结果、目标标签
  - 输出: 抓取姿态列表

**参数**:
- `gene_file`: 网络架构基因文件
- `cornell_data`: Cornell数据集配置
- `model_weights`: 抓取模型权重
- `device`: 计算设备
- `camera_width`: 相机宽度
- `camera_height`: 相机高度

**依赖**:
- PyTorch
- OpenCV
- transforms3d

---

### gripper_server (grasp_control)

**功能**: 控制夹爪

**服务**:
- `/gripper_control` (grasp_interfaces/srv/GripperControl)
  - 输入: 位置 (0=闭合, 1=打开)
  - 输出: 成功/失败

**参数**:
- `robot_ip`: 机械臂IP
- `robot_port`: 机械臂端口

**依赖**:
- 机械臂SDK
- gripper_zhiyuan模块

---

### grasp_executor (grasp_main)

**功能**: 协调整个抓取流程

**动作服务器**:
- `/execute_grasp` (grasp_interfaces/action/ExecuteGrasp)
  - 输入: 目标标签、是否可视化
  - 输出: 成功/失败
  - 反馈: 状态、进度

**订阅话题**:
- `/camera/color/image_raw`
- `/camera/depth/image_raw`

**服务客户端**:
- `/detect_objects`
- `/generate_grasp`
- `/gripper_control`

**参数**:
- `robot_ip`: 机械臂IP
- `robot_port`: 机械臂端口
- `robot_speed`: 机械臂速度
- `max_attempts`: 最大尝试次数

**依赖**:
- 机械臂SDK
- 所有其他节点

---

## 坐标系统

### 坐标系变换链

```
图像坐标系 (u, v)
    │
    │ 相机内参矩阵 K
    ▼
相机坐标系 (xc, yc, zc)
    │
    │ 外参矩阵 Tcam2base
    ▼
机器人基座坐标系 (xb, yb, zb)
    │
    │ 逆运动学
    ▼
关节空间 (θ1, θ2, ..., θ6)
```

### 变换矩阵

**Tcam2base** (4x4齐次变换矩阵):
```
| R11  R12  R13  tx |
| R21  R22  R23  ty |
| R31  R32  R33  tz |
|  0    0    0    1 |
```

其中:
- R: 3x3旋转矩阵
- t: 3x1平移向量

### 边缘补偿策略

根据抓取点在图像中的位置，应用不同的倾斜角度：

```
图像划分区域:
┌─────────┬─────────┬─────────┐
│  左上角  │  上边缘  │  右上角  │
│ slope_x  │ slope_y │-slope_x  │
│ slope_y  │         │ slope_y  │
├─────────┼─────────┼─────────┤
│  左边缘  │  中心区  │  右边缘  │
│ slope_x  │  无补偿  │-slope_x  │
├─────────┼─────────┼─────────┤
│  左下角  │  下边缘  │  右下角  │
│ slope_x  │-slope_y │-slope_x  │
│-slope_y  │         │-slope_y  │
└─────────┴─────────┴─────────┘

slope_angle = π/8 弧度
```

## 通信模式

### 话题 (Topics)
- **用途**: 持续数据流
- **特点**: 发布-订阅模式，异步，多对多
- **示例**: 相机图像流

### 服务 (Services)
- **用途**: 请求-响应交互
- **特点**: 同步调用，一对一
- **示例**: 目标检测、抓取姿态生成

### 动作 (Actions)
- **用途**: 长时间运行的任务
- **特点**: 带反馈和取消功能
- **示例**: 完整抓取流程

## 错误处理

### 碰撞检测与恢复

```
运动指令
    │
    ├─> 检测碰撞
    │       │
    │       ├─> 正常 ──> 继续
    │       │
    │       └─> 碰撞 ──> 恢复流程
    │                       │
    │                       ├─> 停止运动
    │                       ├─> 清除错误
    │                       ├─> 打开夹爪
    │                       ├─> 返回安全位
    │                       └─> 重试/放弃
    │
    └─> 最大尝试次数检查
```

### 异常传播

```
底层异常 (SDK错误)
    │
    ▼
节点异常处理 (try-except)
    │
    ▼
服务/动作响应 (success=False)
    │
    ▼
上层节点处理
    │
    ▼
用户反馈
```

## 性能考虑

### 延迟分析

```
总延迟 = 图像采集 + 检测 + 抓取生成 + 运动规划 + 执行

图像采集:    ~100ms  (10Hz)
目标检测:    ~50-100ms (GPU)
抓取生成:    ~50-100ms (GPU)
逆运动学:    ~10ms
机械臂运动:  ~3-5s

总计: ~3.5-5.5秒/次
```

### 优化策略

1. **模型优化**: 使用TensorRT加速推理
2. **并行处理**: 图像采集与处理并行
3. **缓存**: 缓存常用的关节位姿
4. **分布式**: 检测和抓取生成可部署到不同设备

## 扩展性

### 支持的扩展

1. **多机械臂**: 创建多个控制节点
2. **多相机**: 融合多视角信息
3. **新物体类别**: 重新训练检测模型
4. **新抓取策略**: 修改抓取生成节点
5. **远程控制**: 通过网络调用动作服务
6. **可视化**: 添加RViz可视化节点

### 接口标准化

所有自定义接口都在 `grasp_interfaces` 包中定义，便于：
- 版本控制
- 跨语言使用 (Python/C++)
- 文档生成
- 类型检查

## 与原系统对比

见 `COMPARISON.md`

